<!-- Unified Invoice Upload & Extraction Modal - Reusable for all order pages -->
<div class="modal fade" id="uploadInvoiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title">
          <i class="fa fa-file-invoice me-2"></i>Create Invoice for Order {{ order.order_number }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="manualInvoiceForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_invoice_manual">
        <input type="hidden" name="selected_order_id" value="{{ order.id }}">
        {% if vehicle and vehicle.plate_number %}<input type="hidden" name="plate" value="{{ vehicle.plate_number }}">{% endif %}
        {% if order.customer %}<input type="hidden" name="customer_id" value="{{ order.customer.id }}">{% endif %}
        
        <!-- Hidden fields for additional details -->
        <input type="hidden" name="payment_method" id="hiddenPaymentMethod" value="">
        <input type="hidden" name="delivery_terms" id="hiddenDeliveryTerms" value="">
        <input type="hidden" name="attended_by" id="hiddenAttendedBy" value="">
        <input type="hidden" name="kind_attention" id="hiddenKindAttention" value="">
        <input type="hidden" name="remarks" id="hiddenRemarks" value="">
        <input type="hidden" name="notes" id="hiddenNotes" value="">

        <!-- Quick Info Bar -->
        <div class="alert alert-info mb-3 border-0" role="alert">
          <div class="d-flex align-items-center">
            <i class="fa fa-lightbulb me-3" style="font-size: 18px;"></i>
            <div>
              <strong>Tip:</strong> Upload a PDF invoice to auto-extract data, or fill in the form manually. All fields are editable.
            </div>
          </div>
        </div>

        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <!-- Upload Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-file-upload me-2"></i>Upload PDF (Optional)</strong>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Select PDF File</label>
                <input type="file" id="startedOrderInvoiceFile" class="form-control" accept=".pdf" data-max-file-size="50485760">
                <small class="text-muted">PDF files only. Max 50MB. Leave empty to enter data manually.</small>
              </div>

              <div id="startedUploadError" class="alert alert-danger" style="display:none" role="alert"></div>
              <div id="extractionSuccess" class="alert alert-success" style="display:none" role="alert">
                <i class="fa fa-check-circle me-2"></i>Data extracted successfully! The form below has been auto-populated.
              </div>
              <div id="startedUploadProgress" class="progress" style="display:none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="startedUploadProgressBar" role="progressbar" style="width: 0%"></div>
              </div>

              <button type="button" id="startedUploadBtn" class="btn btn-primary">
                <i class="fa fa-upload me-2"></i>Upload & Extract
              </button>
            </div>
          </div>

          <!-- Extracted Data Preview -->
          <div id="uploadedInvoicePreview" style="display:none;" class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-check-circle me-2 text-success"></i>Extracted Data Preview</strong>
              <small class="text-muted ms-2">Edit the fields below as needed</small>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
              <div class="row g-2">
                <div class="col-md-6">
                  <small class="text-muted d-block">Customer Name</small>
                  <p id="previewCustomerName" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Phone</small>
                  <p id="previewCustomerPhone" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Email</small>
                  <p id="previewCustomerEmail" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Address</small>
                  <p id="previewCustomerAddress" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Invoice Number</small>
                  <p id="previewInvoiceNo" class="mb-2"><strong>-</strong></p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Invoice Date</small>
                  <p id="previewInvoiceDate" class="mb-2"><strong>-</strong></p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted d-block">Subtotal</small>
                  <p id="previewSubtotal" class="mb-0">-</p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted d-block">Tax/VAT</small>
                  <p id="previewTax" class="mb-0">-</p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted d-block">Total</small>
                  <p id="previewTotal" class="mb-0 fs-6"><strong>-</strong></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Line Items (Extracted) -->
          <div id="extractedLineItemsSection" class="card mb-3" style="display:none;">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <div>
                <strong><i class="fa fa-list me-2"></i>Line Items</strong>
                <small class="text-muted ms-2">Review and adjust quantities and prices</small>
              </div>
              <button type="button" id="addLineItemRowBtn" class="btn btn-sm btn-outline-primary">
                <i class="fa fa-plus me-1"></i>Add Row
              </button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 60px; text-align:center;">#</th>
                      <th style="width: 120px;">Code</th>
                      <th>Description</th>
                      <th style="width: 90px;">Unit</th>
                      <th style="width: 100px;">Qty</th>
                      <th style="width: 140px;">Unit Price</th>
                      <th style="width: 60px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="lineItemRowsBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Existing Customer Alert -->
          <div id="existingCustomerAlert" class="alert alert-info alert-dismissible fade show mb-3" style="display:none;">
            <i class="fa fa-info-circle me-2"></i>
            <strong>Existing Customer Found!</strong> A customer with this phone number already exists.
            <span id="existingCustomerName"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>

          <!-- Customer Information Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-user me-2"></i>Customer Information</strong>
            </div>
            <div class="card-body">
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label">Full Name *</label>
                  <input type="text" name="customer_name" class="form-control" id="manualCustomerName" value="{{ order.customer.full_name }}" placeholder="Customer full name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Phone <small class="text-muted">(optional)</small></label>
                  <input type="tel" name="customer_phone" class="form-control" id="manualCustomerPhone" placeholder="Phone number" value="{{ order.customer.phone|default:'' }}">
                </div>
              </div>
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                  <input type="email" name="customer_email" class="form-control" placeholder="email@example.com" value="{{ order.customer.email|default:'' }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Customer Type *</label>
                  <select name="customer_type" id="invoiceCustomerType" class="form-select" required>
                    <option value="">Select customer type</option>
                    <option value="personal" {% if order.customer.customer_type == 'personal' %}selected{% endif %}>Personal</option>
                    <option value="company" {% if order.customer.customer_type == 'company' %}selected{% endif %}>Private Company</option>
                    <option value="ngo" {% if order.customer.customer_type == 'ngo' %}selected{% endif %}>NGO</option>
                    <option value="government" {% if order.customer.customer_type == 'government' %}selected{% endif %}>Government</option>
                  </select>
                </div>
              </div>
              
              <!-- Personal Subtype (shown only for personal type) -->
              <div class="row mb-2" id="personalSubtypeWrapper" style="display:none;">
                <div class="col-md-6">
                  <label class="form-label">Personal Subtype</label>
                  <select name="customer_personal_subtype" class="form-select">
                    <option value="">Select subtype</option>
                    <option value="owner">Owner</option>
                    <option value="driver">Driver</option>
                  </select>
                </div>
              </div>

              <!-- Organization Fields (shown for non-personal types) -->
              <div class="row mb-2" id="organizationDetailsWrapper" style="display:none;">
                <div class="col-md-6">
                  <label class="form-label">Organization Name</label>
                  <input type="text" name="customer_organization_name" class="form-control" id="organizationNameField" placeholder="Organization name" value="{{ order.customer.organization_name|default:'' }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tax Number</label>
                  <input type="text" name="customer_tax_number" class="form-control" id="taxNumberField" placeholder="Tax identification number" value="{{ order.customer.tax_number|default:'' }}">
                </div>
              </div>

              <div class="row mb-2">
                <div class="col-md-12">
                  <label class="form-label">Address</label>
                  <input type="text" name="customer_address" class="form-control" placeholder="Customer address" value="{{ order.customer.address|default:'' }}">
                </div>
              </div>
            </div>
          </div>

          <!-- Invoice Information Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-file-invoice me-2"></i>Invoice Information</strong>
            </div>
            <div class="card-body">
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Invoice Number</label>
                  <input type="text" name="invoice_number" class="form-control" placeholder="e.g., INV-001">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Invoice Date</label>
                  <input type="date" name="invoice_date" class="form-control" value="{% now 'Y-m-d' %}" required>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Information Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-money me-2"></i>Payment Information</strong>
            </div>
            <div class="card-body">
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Subtotal</label>
                  <div class="input-group">
                    <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                    <input type="number" name="subtotal" class="form-control" step="0.01" min="0" placeholder="0.00">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Tax/VAT</label>
                  <div class="input-group">
                    <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                    <input type="number" name="tax_amount" class="form-control" step="0.01" min="0" placeholder="0.00">
                  </div>
                </div>
              </div>

              <div class="row mb-2">
                <div class="col-md-12">
                  <label class="form-label fw-bold">Total Amount *</label>
                  <div class="input-group">
                    <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                    <input type="number" name="total_amount" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 20px; background: #f8f9fa;">
          <div class="text-center w-100 mb-3">
            <p class="text-muted small mb-0">
              <i class="fa fa-info-circle me-1"></i>
              Fill in the required fields (marked with *), then click the button below to create the invoice.
            </p>
          </div>
          <div class="w-100 d-flex gap-2" style="margin-top: -15px;">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fa fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-success btn-lg flex-grow-1" style="font-weight: 600;">
              <i class="fa fa-check-circle me-2"></i>Create Invoice
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
